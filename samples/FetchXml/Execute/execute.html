<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Fetch method sample</title>
    <!-- Activate IE9 document mode, if available. -->
    <!-- If missing, the WebBrowser control on Windows runs in default IE8 mode which is not supported by JSBridge. -->
    <meta http-equiv='X-UA-Compatible' content='IE=edge' />
    <!-- Defined iOS viewport -->
    <!-- If missing, the UIWebView control on iOS zooms out the web page and allows the pinch zoom. -->
    <meta name='viewport' content='initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no'>
    <script type="text/javascript" src="JSBridge.js"></script>
</head>
<body>
    <script>
        function executeFromXml(resultFormat) {
            var xmlFetch = "<fetch resultformat='" + resultFormat + "' aggregate='false'>" +
                                           "<entity name='salesorder'>" +
                                               "<attribute name='name' />" +
                                               "<attribute name='shipto_city' />" +
                                               "<attribute name='shipto_line1' />" +
                                               "<attribute name='totalamount' />" +
                                                   "<filter>" +
                                                       "<condition attribute='name' operator='like' value='Bike%'  />" +
                                                       "<condition attribute='totalamount' operator='gt' value='1500'  />" +
                                                   "</filter>" +
                                           "</entity>" +
                                       "</fetch>";

            MobileCRM.FetchXml.Fetch.executeFromXML(xmlFetch, function (result) {
                if (result.length < 1) {
                    MobileCRM.bridge.alert("Not any order begins with 'Bike' and total amount grater than 1500 was found");
                }
                else {
                    var info = "Info [Missing ship - to address]: \n";
                    switch (resultFormat) {
                        case "Array":
                            for (var i in result) {
                                var entity = result[i];
                                /// Append orders what doesn't have filled 'ship to address' to info message
                                /// indexes are ordered by attributes in xml
                                var shipToCity = entity[1];
                                var shipToAddress = entity[2];
                                if (!(shipToAddress && shipToCity))
                                    info += "\nName: " + entity[0] + " Total amount: " + entity[3];
                            }
                            break;
                        case "JSON":
                            for (var i in result) {
                                /// Deserialize json object
                                var entity = result[i];
                                var shipToCity = entity.shipto_city;
                                var shipToAddress = entity.shipto_line1;
                                if (!(shipToAddress && shipToCity))
                                    info += "\nName: " + entity.name + " Total amount: " + entity.totalamount;
                            }
                            break;
                        default: //DynamicEntities
                            for (var i in result) {
                                /// Deserialize json object
                                var entity = result[i];
                                var shipToCity = entity.properties.shipto_city;
                                var shipToAddress = entity.properties.shipto_line1;
                                if (!(shipToAddress && shipToCity))
                                    info += "\nName: " + entity.primaryName + " Total amount: " + entity.properties.totalamount;
                            }
                            break;
                    }
                    MobileCRM.bridge.alert(info);
                }
            }, MobileCRM.bridge.alert, null);
        }

        function executeFetch(online) {
            var fetchEntity = new MobileCRM.FetchXml.Entity("salesorder");
            fetchEntity.addAttribute("name");
            fetchEntity.addAttribute("shipto_city");
            fetchEntity.addAttribute("totalamount");

            var filter = new MobileCRM.FetchXml.Filter();
            filter.type = "and";

            var cond1 = new MobileCRM.FetchXml.Condition();
            cond1.attribute = "name";
            cond1.operator = "like";
            cond1.value = "Bike%";

            var cond2 = new MobileCRM.FetchXml.Condition();
            cond2.attribute = "totalamount";
            cond2.operator = "gt"
            cond2.value = "1500%";

            filter.conditions.push(cond1, cond2);

            fetchEntity.filter = filter;

            var fetch = new MobileCRM.FetchXml.Fetch(fetchEntity);

            var info = "Info [Missing ship - to address]: \n";

            if (online) {
                fetch.executeOnline("DynamicEntities", function (result) {
                    if (result.length < 1) {
                        MobileCRM.bridge.alert("Not any order begins with 'Bike' and total amount grater than 1500 was found");
                    }
                    else {
                        for (var i in result) {
                            var entity = result[i];
                            var shipToCity = entity.properties.shipto_city;
                            var shipToAddress = entity.properties.shipto_line1;
                            if (!(shipToAddress && shipToCity))
                                info += "\nName: " + entity.primaryName + " Total amount: " + entity.properties.totalamount;
                        }
                    }
                }, MobileCRM.bridge.alert, null);
            }
            else {
                fetch.executeOffline("DynamicEntities", function (result) {
                    if (result.length < 1) {
                        MobileCRM.bridge.alert("Not any order begins with 'Bike' and total amount grater than 1500 was found");
                    }
                    else {
                        for (var i in result) {
                            var entity = result[i];
                            var shipToCity = entity.properties.shipto_city;
                            var shipToAddress = entity.properties.shipto_line1;
                            if (!(shipToAddress && shipToCity))
                                info += "\nName: " + entity.primaryName + " Total amount: " + entity.properties.totalamount;
                        }
                    }
                }, MobileCRM.bridge.alert, null);
            }
        }

        function executeAsync() {
            var fetchEntity = new MobileCRM.FetchXml.Entity("salesorder");
            fetchEntity.addAttribute("name");
            fetchEntity.addAttribute("shipto_city");
            fetchEntity.addAttribute("totalamount");

            var filter = new MobileCRM.FetchXml.Filter();
            filter.type = "and";

            var cond1 = new MobileCRM.FetchXml.Condition();
            cond1.attribute = "name";
            cond1.operator = "like";
            cond1.value = "Bike%";

            var cond2 = new MobileCRM.FetchXml.Condition();
            cond2.attribute = "totalamount";
            cond2.operator = "gt"
            cond2.value = "1500%";

            filter.conditions.push(cond1, cond2);

            fetchEntity.filter = filter;

            var fetch = new MobileCRM.FetchXml.Fetch(fetchEntity);

            var info = "Info [Missing ship - to address]: \n";

            fetch.executeAsync(null).then((result) => { // "null" stands for default "DynamicEntities" result format
                if (result.length < 1) {
                    MobileCRM.bridge.alert("Not any order begins with 'Bike' and total amount grater than 1500 was found");
                }
                else {
                    for (var i in result) {
                        var entity = result[i];
                        var shipToCity = entity.properties.shipto_city;
                        var shipToAddress = entity.properties.shipto_line1;
                        if (!(shipToAddress && shipToCity))
                            info += "\nName: " + entity.primaryName + " Total amount: " + entity.properties.totalamount;
                    }
                }
                MobileCRM.bridge.alert(info);
            }).catch((err) => {
                MobileCRM.bridge.alert(err);
            });
        }

    </script>
    <h3>Welcome to sample page for fetchXml method.</h3>
    Help: <a href="https://github.com/Resconet/JSBridge">Git repository...</a>
    <br />
    <h4>Run sample</h4>
    <button onclick="executeFromXml('Array')">ExecuteXml to Array</button>
    <button onclick="executeFromXml('JSON')">ExecuteXml to Json</button>
    <button onclick="executeFromXml('DynamicEntities')">ExecuteXml to DynamicEntities</button>

    <button onclick="executeFetch()">Fetch to DynamicEntities</button> <b>offline</b><br />
    <button onclick="executeFetch(true)">Fetch to DynamicEntities</button>  <b>online</b>
</body>
</html>
